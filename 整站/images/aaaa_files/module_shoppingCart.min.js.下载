Site.ShoppingCart=function(a){this.moduleId=a;this.module=Fai.top.$("#module"+a);this.shoppingCart=this.module.find(".shoppingCart"+a);this.cartButton=this.module.find(".cartButton");this.cartListWrap=Fai.top.$(".J_cartListWrap"+a);this.cartList=this.cartListWrap.find(".dropCartList");this.colorCode=this.module.find(".shoppingCartBox").attr("cartColor")};(function(h,a,d){var i=a.prototype;var o="";i.TITLE="最新加入的商品";i.init=function(){this.initBind();Fai.top.$("#g_main").append(this.cartListWrap);this.refreshData();g(this.colorCode,this.module,this.cartList)};i.initBind=function(){var s,r,u=false,v=false;var t=this;var q=this.cartButton,p=this.cartList;if(Fai.top._colId!=13&&Fai.top._colId!=14){q.off("click.sC").on("click.sC",function(){window.open("mcart.jsp","_blank")});q.off("mouseenter.sC").on("mouseenter.sC",function(){if(v){clearTimeout(r);v=false}if(p.is(":hidden")){q.addClass("cartButton_hover");p.css("opacity",0);p.css("height","");p.addClass("dropCartList_hover");var w=p.height();p.css("height",0);n(t.cartListWrap,t.moduleId);p.stop(true,false).animate({height:w,opacity:1},200,function(){p.css("height","");q.addClass("cartButton_hover")});l(t);t.refreshData(t.moduleId)}});q.off("mouseleave.sC").on("mouseleave.sC",function(){u=true;s=setTimeout(function(){q.removeClass("cartButton_hover");p.stop(true,true).animate({height:0,opacity:0},100,function(){p.removeClass("showCartRight dropCartList_hover");q.removeClass("cartButton_hover");p.css("height","")})},50)});p.off("mouseenter.sC").on("mouseenter.sC",function(){if(u){clearTimeout(s);u=false}});p.off("mouseleave.sC").on("mouseleave.sC",function(){v=true;r=setTimeout(function(){q.removeClass("cartButton_hover");p.stop(true,true).animate({height:0,opacity:0},100,function(){p.removeClass("showCartRight dropCartList_hover");q.removeClass("cartButton_hover");p.css("height","")})},50)})}};i.refreshData=function(q){var p=this;h.ajax({type:"post",url:"ajax/order_h.jsp?cmd=getTopBarMallCartList",data:"",success:function(r){var s=h.parseJSON(r);var t=s.topBarProductList;if(s.success&&t.length>0){p.refrestCartList(s.topBarProductList,s.orderId,s.choiceCurrencyVal)}else{p.cartList.html(e());p.cartList.removeClass("dropCartList_goods");Fai.top.$(".shoppingAmount").css("display","none");Fai.top.$(".shoppingAmountContent").css("display","none");Fai.top.$("#mallCart_js").find(".mallCart_proNum").text("(0)");Fai.top.$("#J_WebRightBar").find(".fk-rbar-cartItem-cirNum").text("0")}}})};i.refrestCartList=function(t,r,C){c();var y,B,w,x=t.length,E=Fai.top.$(".shoppingAmount"),q=0,p=0,D=0,s=0;o=k(this.colorCode);var A=[],z=[];A.push("<div class='cartContent'>");A.push("<div class='sCart-title'>");A.push("<h4>"+LS.memberMallCartJoin+"</h4>");A.push("</div>");A.push("<div class='sC-Content'>");A.push("<ul class='sC-sigleList'>");for(B=0;B<x;B++){var u=t[B],v=u.amount;q+=v}for(y=0;y<x;y++){var u=t[y],v=u.amount;if(u.isValid){D+=u.price*v}}for(y=0;y<x;y++){var u=t[y],v=u.amount;if(u.isValid){A.push(j(u,r,C))}else{z.push(j(u,r,C))}s+=1;if(s>=5){break}}A.push(z.join(""));if(q>0){if(q>99){Fai.top.$("#J_WebRightBar").find(".fk-rbar-cartItem-cirNum").text("...")}else{Fai.top.$("#J_WebRightBar").find(".fk-rbar-cartItem-cirNum").text(q)}p=q;q=q>99?"99+":q;E.text(q);Fai.top.$("#mallCart_js").find(".mallCart_proNum").text("("+q+")");this.cartList.addClass("dropCartList_goods");E.css("display","block");Fai.top.$(".shoppingAmountContent").css("display","block")}A.push("</ul>");A.push("</div>");A.push("</div>");A.push("<div class='cartCalculate'>");A.push(Fai.format(LS.shoppingCartCalculatePro,p));A.push("<span class='sC-priceTotal'>"+LS.shoppingCartCountMoney+"<b style='color:"+o+";'>"+C.toString()+D.toFixed(2)+"</b></span>");A.push("</div>");A.push("<div class='cartPayFor'>");A.push("<a href='javascript:;' class='sC-payFor' style='background-color:"+o+";'>"+LS.memberMallCartCheckBtn+"</a>");A.push("</div>");this.cartList.find(".shoppingList").html(A.join(""));f(this,r)};i.delShoppingCartItem=function(p,s,r){var q=this;h.ajax({type:"post",url:"ajax/order_h.jsp?cmd=delItem",data:{orderId:p,itemId:s,isTopBarMallCart:true},error:function(t){var u=h.parseJSON(t);if(!u.success){Fai.ing("系统繁忙，请稍后重试。",true)}},success:function(t){var u=h.parseJSON(t);if(u.success){if(q.cartList.find(".sCart-sigle").length>1){if(q.cartList.find(".sCart-sigle").length>4){q.cartList.find(".sC-Content").css("height","295px")}else{q.cartList.find(".sC-Content").css("height","")}q.cartList.find(".sCart-sigle").eq(r).stop(true,true).animate({height:"0"},400,function(){q.refreshData()})}else{q.refreshData()}}else{if(u.rt==-2){Fai.ing("参数错误，请稍后重试。",true)}}}})};function f(s,p){var r=s,q=s.module;var t=s.cartList.find(".sC-delItem");t.each(function(){var u=h(this);u.off("click.sC").on("click.sC",function(){r.delShoppingCartItem(p,u.attr("tmpproductid"),t.index(u))})});s.cartList.find(".cartPayFor a").off("click.sC").on("click.sC",function(){window.open("mcart.jsp","_blank")})}function l(q){var p=q.cartList||q.module.find(".dropCartList");if(p.offset().left<0){p.addClass("showCartRight")}}function j(u,p,t){c();var v=u.isValid;var r=u.inValidType;var s=[];s.push("<li class='sCart-sigle "+(v?"":"invalidItem")+"' itemId='"+u.id+"'>");s.push("<div class='sC-img'>");s.push("<img width='60' height='60' alt="+Fai.encodeHtml(u.name)+" src="+u.picPath+">");s.push("</div>");if(!v){if(r=="notAdded"||r=="delete"){s.push("<div class='notAdded'><span class='notAddedTip' title='"+LS.notAdded+"'>"+LS.notAdded+"</span><i class='visible'></i></div>")}else{if(r=="outOfStock"){s.push("<div class='notAdded'><span class='notAddedTip' style='font-size: 12px;line-height: normal;' title='"+LS.invalid+"'>"+LS.invalid+"</span><i class='visible'></i></div>")}}}s.push("<div class='sC-proLeft' style=' width: 100px'>");s.push("<span class='sC-pdName' style='width:80px;' title='"+Fai.encodeHtml(u.name)+"'>"+Fai.encodeHtml(u.name)+"</span>");s.push("<span class='sC-pdOption' style='width:135px;' title='"+Fai.encodeHtml(u.optionType)+"'>"+Fai.encodeHtml(u.optionType)+"</span>");s.push("</div>");var q=u.amount;if(q>9999){q=(q+"").substring(0,3)+"..."}s.push("<div class='sC-detail'>");s.push("<a class='sC-delItem' style='font-size:12px;' hidefocus='true' href='javascript:;' itemId='"+u.id+"'  tmpProductId='"+u.id+"'>"+LS.memberMallCartDel+"</a>");s.push("<span class='sC-amount' style='position:relative;float:right;'>x"+q+"</span>");s.push("<span class='sC-price' style='float:right;margin-top:-20px;margin-right:30px;color:"+o+";'>"+t.toString()+u.price.toFixed(2)+"</span>");s.push("</div>");s.push("</li>");return s.join("")}function e(){c();var q=i.noGoodsHtmlStr;if(q==d){var p=[];p.push("<div class='cartSpacer'></div>");p.push("<div class='shoppingList'>");p.push("<div class='cartNoGoods'>");p.push("<b></b>");p.push("<div class='noGoodsText'>");p.push("<p>"+LS.memberMallCartNoProduct+"</p>");p.push("</div>");p.push("</div>");p.push("</div>");i.noGoodsHtmlStr=p.join("")}return i.noGoodsHtmlStr}function c(){if(!LS){Fai.ing("多语言文件未引入",false)}}function m(p){return(p.indexOf("#")<0&&(p.indexOf("rgba")>=0||p.indexOf("RGBA")>=0))}function b(q){if(!m(q)){return}if(q.indexOf("transparent")>=0){return"rgb(255,255,255)"}var p=q.split("(")[1].split(")")[0].split(",");return"rgb("+p[0]+","+p[1]+","+p[2]+")"}function k(p){if(Fai.isIE6()||Fai.isIE7()||Fai.isIE8()){if(m(p)){return b(p)}}return p}function g(s,t,p){if(!Fai.isIE6()&&!Fai.isIE7()&&!Fai.isIE8()){return}if(!m(s)){return}var r=b(s);var q=t.find(".shoppingCartBox").hasClass("shoppingCartRange1");t.find(".shoppingCartBox").attr("cartColor",r);if(q){t.find(".cartButton").css("background-color",r)}if(!q){t.find(".cartLeft").css("background-color",r)}t.find(".shoppingAmount").css("background-color",r);t.find(".shoppingAmount2").css("border-bottom-color",r);if(q){p.css("border","2px solid "+r)}}function n(p,t){var s,v,r,u=Fai.top.$("#module"+t),q=u.parent().hasClass("J_bottomFloatLayerContent"),w="";s=Site.getModuleGMainRect(t);v=s.right;r=s.top;w=q?9030:w;p.css({left:v-p.find(".dropCartList").outerWidth(),top:r,"z-index":w})}})(jQuery,Site.ShoppingCart);Site.initShoppingCart=function(a){Fai.top.shoppingCart=Fai.top.shoppingCart||{};Fai.top.shoppingCart["cart"+a]=new Site.ShoppingCart(a);Fai.top.shoppingCart["cart"+a].init()};